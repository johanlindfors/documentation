\ProvidesPackage{area51}
% Declare area51
\DefineFamily{area51}
% Required Packages
\RequirePackage{multido}
\RequirePackage{setspace}
\RequirePackage{xcolor}
\RequirePackage{transparent}
\RequirePackage[many]{tcolorbox}

% simple forLoop using multido https://stackoverflow.com/a/27339164
\newcommand{\forLoop}[4][1]{\multido{\i=#2+#1}{#3}{#4}}

%--------------------------------------------------------------------------------------------------
% cfbox which allows a coloured border around a box to be drawn based on which border
% we want
% see https://tex.stackexchange.com/a/55534
\newcommand\cfbox[3][lbrt]{%
    \begingroup
    \leavevmode
    \setbox\@tempboxa\hbox{%
        \color@begingroup
        \kern\fboxsep{#3}\kern\fboxsep
        \color@endgroup
    }%
    \@tempdima\fboxrule
    \advance\@tempdima\fboxsep
    \advance\@tempdima\dp\@tempboxa
    \hbox{%
        \hskip-.5\fboxrule
        \lower\@tempdima\hbox{%
            \vbox{%
                \in@{t}{#1}\ifin@{\color{#2}\hrule\@height\fboxrule}\fi
                \hbox{%
                    \in@{l}{#1}\ifin@{\color{#2}\vrule\@width\fboxrule}\else{\hskip\fboxrule}\fi
                    \vbox{\vskip\fboxsep\box\@tempboxa\vskip\fboxsep}%
                    \in@{r}{#1}\ifin@{\color{#2}\vrule\@width\fboxrule}\else{\hskip\fboxrule}\fi
                }%
                \in@{b}{#1}\ifin@{\color{#2}\hrule\@height\fboxrule}\fi
            }%
        }%
        \hskip-.5\fboxrule
    }%
    \endgroup
}

% dimcfbox[borders]{colour}{width}{height}{text}
\newcommand\dimcfbox[5][lbrt]{%
    \cfbox[#1]{#2}{%
        \vbox to #4 {%
            \hbox to #3 {#5}%
        }%
    }%
}

%--------------------------------------------------------------------------------------------------
\newcommand\hexmapside{l}%
\newcommand\hexmapborders{tlrb}%

\newcommand\hexmap[2]{%
    \begingroup%
    \in@{l}{#1}\ifin@{%
        \renewcommand{\hexmapside}{l}%
        \renewcommand{\hexmapborders}{rb}%
        {#2}%
    }\fi%
    \in@{r}{#1}\ifin@{%
        \renewcommand{\hexmapside}{r}%
        \renewcommand{\hexmapborders}{lb}%
        {#2}%
    }\fi%
    \endgroup%
    \linebreak\relax%
}

%--------------------------------------------------------------------------------------------------
% hexmaprow{l}{rowId}{content} for row with rowId in left column
% hexmaprow{r}{rowId}{content} for row with rowId in right column
%
% Here we generate the row then reduce the height by 0.5\fboxsep to remove the separation
% between each line. This seems to work
\newcommand\hexmapcellwidth{1.1cm}
\newcommand\hexmapheaderwidth{0.5cm}
\newcommand\hexmaprow[2]{%
    \begingroup%
    \sbox{0}{%
        \expandafter\in@\expandafter{\hexmapside}{l}\ifin@{%
                \cfbox[r]{black}{\vbox to \hexmapcellwidth {\vfil\hbox to \hexmapheaderwidth {\hfil{#1}}\vfil}}%
        }\fi%
        {#2}%
        \expandafter\in@\expandafter{\hexmapside}{r}\ifin@{%
            \cfbox[l]{black}{\vbox to \hexmapcellwidth {\vfil\hbox to \hexmapheaderwidth {{#1}\hfil}\vfil}}%
        }\fi%
    }%
    \ht0=\dimexpr \hexmapcellwidth + 0.5\fboxsep + \fboxrule\relax%
    %\ht0=\dimexpr \ht0 - .5\fboxsep\relax%
    \usebox{0}%
    \endgroup%
}

\newcounter{hexmapcolnumber}
\newcommand\hexmapheadercell[1]{\cfbox[b]{black}{\vbox to \hexmapheaderwidth {\vfil\hbox to \hexmapcellwidth {\hfil {#1} \hfil}\vfil}}}
\newcommand\hexmapheader[2] {
    \begingroup%
    \sbox{0}{%
        \expandafter\in@\expandafter{\hexmapside}{l}\ifin@{%
            \cfbox[]{black}{\vbox to \hexmapheaderwidth {\vfil\hbox to \hexmapheaderwidth {~}\vfil}}%
        }\fi%
        \forLoop{#1}{#2}{\hexmapheadercell{\i}}%
        \expandafter\in@\expandafter{\hexmapside}{r}\ifin@{%
            \cfbox[]{black}{\vbox to \hexmapheaderwidth {\vfil\hbox to \hexmapheaderwidth {~}\vfil}}%
        }\fi%
    }%
    \ht0=\dimexpr \hexmapcellwidth + 0.5\fboxsep + \fboxrule\relax%
    \usebox{0}%
    \endgroup%
}

%--------------------------------------------------------------------------------------------------
% font for opcodecell - tends to be 6pt to fit z80 instructions or 32 bit opcodes
\makeatletter
\newcommand\opcodecellfont{\@setfontsize\opcodecellfont\@vipt\@viipt}
\makeatother

%--------------------------------------------------------------------------------------------------
% opcodecell to define a specific cell with an opcode
%
%   +-----------------+
%   |     opcode      |
%   | size      cycle |
%   |      hex        |
%   +-----------------+
%
% \opcodecell{opcode}{opcodeHex}{SizeBytes}{CycleCount}
%

\newcommand\opcodecell[4]{%
    \begingroup%
    \expandafter\cfbox\expandafter[\hexmapborders]{black}{%
        \vbox to \hexmapcellwidth {%
            \hbox to \hexmapcellwidth {\opcodecellfont\hfil{#1}\hfil}
            \hbox to \hexmapcellwidth {\opcodecellfont{#3}\hfil{#4}}
            \hbox to \hexmapcellwidth {\opcodecellfont\hfil{#2}\hfil}%
        }%
    }%
    \endgroup%
}

%--------------------------------------------------------------------------------------------------

\newcommand\opcodesimplecell[1]{%
    \begingroup%
    \expandafter\cfbox\expandafter[\hexmapborders]{black}{%
        \vbox to \hexmapcellwidth {%
            \hbox to \hexmapcellwidth {#1}%
        }%
    }%
    \endgroup%
}

%--------------------------------------------------------------------------------------------------
% Processor flags
\newcommand\processorFlagHeight{0.3cm}
\newcommand\processorFlagWidth{0.25cm}
\newcommand\processorFlagLabelWidth{1cm}

\newcommand\processorFlags[1]{
    \begingroup
    \normalsize{#1}
    \endgroup
}

\newcommand\processorFlagRow[1]{%
    \begingroup%
    \sbox{0}{#1}%
    \ht0=\dimexpr \processorFlagHeight + 0.5\fboxsep + \fboxrule\relax%
    \usebox{0}%
    \endgroup%
    \\\relax
}

\newtcbox{\processorFlag}{blank, boxsep=0mm,
    clip upper, minipage,
    width=0.4cm, height=0.4cm,nobeforeafter,
    halign=center, valign=center,
    borderline={0.4pt}{0pt}{blue!20!white},
}

\newtcbox{\processorFlagHeader}{blank, boxsep=0mm,
    clip upper, minipage,
    width=1cm, height=0.4cm,nobeforeafter,
    halign=right, valign=center, right*=2pt,
}

\newtcbox{\processorFlagLabel}{blank, boxsep=0mm,
    clip upper, minipage,
    halign=right, valign=center, right*=2pt,
    fontupper=\small,
    width=1cm, height=0.4cm,nobeforeafter,
}

\newtcbox{\processorFlagDef}{blank, boxsep=0mm,
    clip upper, minipage,
    halign=left, valign=center,
    fontupper=\small,
    width=8cm, height=0.4cm,nobeforeafter,
}

%\newcommand\processorFlag[1]{\dimcfbox[trb]{black}{\processorFlagWidth}{\processorFlagHeight}{#1}}
%\newcommand\processorFlagHeader[1]{\dimcfbox[tblr]{black}{\processorFlagLabelWidth}{\processorFlagHeight}{\hfil{#1}~}}
%\newcommand\processorFlagLabel[1]{\dimcfbox[]{black}{\processorFlagLabelWidth}{\processorFlagHeight}{\hfil{#1}~}}

%--------------------------------------------------------------------------------------------------
