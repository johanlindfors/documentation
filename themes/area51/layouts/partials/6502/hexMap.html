{{- if isset .Params "hexgrid" -}}

{{- /* dict holding which colours are in use so legend becomes dynamic */ -}}
{{- $colours := dict -}}

{{- range $prefix, $grid := $.Params.hexgrid -}}
<div class="row">
    <table class="hexGrid">
        {{- if ne $prefix "00" -}}
        <caption>Opcodes with prefix {{ $prefix }}</caption>
        {{- end -}}
        <thead>
        <tr>
            <th></th>
            {{- range seq 0 15 -}}
            <th>{{ printf "%X" . }}</th>
            {{- end -}}
        </tr>
        </thead>
        <tbody>
        {{- range $h, $r := $grid -}}
        <tr>
            <th>{{ printf "%X" $h }}</th>
            {{- range $l, $c := $r -}}
            {{- if ne $c.label "" -}}

            {{- /* Store colour so we can restrict the legend */ -}}
            {{- $d := dict $c.colour 1 }}{{ $colours = merge $colours $d -}}

            <td class="{{$c.colour}}">
                <div>
                    <span class="op">{{- partial "6502/instruction.html" (dict "op" $c.label "mode" $c.addressing) -}}</span>
                    {{- with $c.op }}<span class="code">{{.}}</span>{{ end -}}
                    {{- with $c.size }}<span class="size">{{.}}</span>{{ end -}}
                    {{- with $c.cycles }}<span class="cycles">{{.}}</span>{{ end -}}
                </div>
            </td>
            {{- else -}}
            <td class="unused">
                <div></div>
            </td>
            {{- end -}}
            {{- end -}}
        </tr>
        </tbody>
        {{- end -}}
    </table>
</div>

{{- end -}}
<table class="memoryMap2">
    <caption>Opcode Matrix Legend</caption>
    <tbody>
    <tr>
        <td class="legend">
            <div>
                <span class="op">Opcode <em>Address mode</em></span>
                <span class="code">Opcode hex</span>
                <span class="size">Size bytes</span>
                <span class="cycles">Cycle count</span>
            </div>
        </td>

        {{- if index $colours "green" -}}<td class="bnone">&nbsp;</td><td class="green blrtb">Register</td>{{- end -}}

        {{- if index $colours "yellow" -}}<td class="bnone">&nbsp;</td><td class="yellow blrtb">Memory</td>{{- end -}}

        {{- if index $colours "blue" -}}<td class="bnone">&nbsp;</td><td class="blue blrtb">Implicit</td>{{- end -}}

        {{- if index $colours "orange" -}}<td class="bnone">&nbsp;</td><td class="orange blrtb">Math</td>{{- end -}}

        {{- if index $colours "darkgreen" -}}<td class="bnone">&nbsp;</td><td class="darkgreen blrtb">Logic</td>{{- end -}}

        {{- if index $colours "darkblue" -}}<td class="bnone">&nbsp;</td><td class="darkblue blrtb">Flow</td>{{- end -}}

        {{- if index $colours "red" -}}<td class="bnone">&nbsp;</td><td class="red blrtb">Interrupt</td>{{- end -}}

        {{- if index $colours "grey" -}}<td class="bnone">&nbsp;</td><td class="grey blrtb">Special</td>{{- end -}}

        {{- if index $colours "" -}}<td class="bnone">&nbsp;</td><td class="unused blrtb">Undefined</td>{{- end -}}

    </tr>
    </tbody>
</table>
{{- end -}}
