{{- if isset .Params "flags" }}{{ partial "6502/flags.html" .Params.flags }}{{end -}}
{{- if isset .Params "hide_codes" -}}{{- else -}}
{{- if isset .Params "codes" -}}
{{- $opcode := $.Params.codes -}}
{{- if isset .Params "code_axis" | not -}}
{{- if isset .Params "notitle" | not -}}
<div class="printPageBreakAvoid">
    <h3>Instructions</h3>
    {{- end -}}
    <table class="table table-striped table-hover table-sm table-borderless">
        <thead>
        <tr>
            {{- if isset .Params "src" -}}
            <th scope="col" rowspan="2">{{.Params.src}}</th>
            {{- end -}}
            {{- if isset .Params "dest" -}}
            <th scope="col" rowspan="2">{{.Params.dest}}</th>
            {{- end -}}
            <th scope="col" rowspan="2">Syntax</th>
            {{- if isset .Params "alt" -}}
            <th scope="col" rowspan="2">{{.Params.alt}}</th>
            {{- end -}}
            <th scope="col">Opcode</th>
            <th scope="col" colspan="3">Available on:</th>
            <th scope="col"># of</th>
            <th scope="col"># of</th>
            <th scope="col" rowspan="2">Addressing Mode</th>
            {{- if isset .Params "altright" -}}
            <th scope="col" rowspan="2">{{.Params.altright}}</th>
            {{- end -}}
        </tr>
        <tr>
            <th><em>(hex)</em></th>
            <th>6502</th>
            <th>65C02</th>
            <th>65816</th>
            <th>bytes</th>
            <th>cycles</th>
        </tr>
        </thead>
        <tbody>
        {{- range $.Params.codes -}}
        {{- if isset $.Params "op" }}{{ $.Scratch.Set "op" $.Params.op }}{{end -}}
        {{- if isset . "op" }}{{ $.Scratch.Set "op" .op }}{{end -}}
        {{- $op := $.Scratch.Get "op" -}}
        <tr>
            {{- if isset $.Params "src" }}
            <td>{{.src}}</td>
            {{end -}}
            {{- if isset $.Params "dest" }}
            <td>{{.dest}}</td>
            {{end -}}
            <td>{{ partial "6502/instruction.html" (dict "op" $op "mode" .addressing "val" "addr") }}</td>
            {{- if isset $.Params "alt" }}
            <td>{{.alt}}</td>
            {{end -}}
            <td>{{.code}}</td>
            <td>{{ if isset .compatibility "6502" }}x{{end }}</td>
            <td>{{ if isset .compatibility "65c02" }}x{{end }}</td>
            <td>{{ if isset .compatibility "65816" }}x{{end }}</td>
            <td>{{ partial "6502/notablevalue.html" .bytes }}</td>
            <td>{{ partial "6502/notablevalue.html" .cycles }}</td>
            <td>{{ partial "6502/addressmode.html" .addressing }}</td>
            {{- if isset $.Params "altright" }}
            <td>{{.altright}}</td>
            {{end -}}
        </tr>
        {{- end -}}
        </tbody>
    </table>
</div>
{{- else -}}
{{- $opprefix := $.Params.op -}}

{{- $rowCount := 0 -}}
    {{- range $dest := $.Params.code_axis -}}
        {{- $rowValid := 0 -}}
        {{- range $src := $.Params.code_axis -}}
            {{- range $op := $.Params.codes -}}
            {{- $opc := printf "%s %s, %s" $opprefix $dest $src -}}
            {{- if eq $opc $op.op}}{{$rowValid = 1}}{{end -}}
            {{- end -}}
        {{- end -}}
    {{- if $rowValid -}}{{ $rowCount := add $rowCount 1 }}{{- end -}}
{{- end -}}

<table class="memoryMap3">
    <caption>Syntax: <strong>{{$opprefix}}</strong> <em>DEST</em>, <em>SOURCE</em></caption>
    <thead>
    <tr>
        <th class="bnone" rowspan="2" colspan="2"></th>
        <th colspan="{{len $.Params.code_axis}}">Source</th>
    </tr>
    <tr>
        {{- range $.Params.code_axis}}<th>{{.}}</th>{{end -}}
    </tr>
    </thead>
    <tbody>
    {{- range $lineNo, $dest := $.Params.code_axis -}}
        {{- $rowValid := 0 -}}
        {{- range $src := $.Params.code_axis -}}
            {{- range $op := $.Params.codes -}}
            {{- $opc := printf "%s %s, %s" $opprefix $dest $src -}}
            {{- if eq $opc $op.op}}{{$rowValid = 1}}{{end -}}
            {{- end -}}
        {{- end -}}
    {{- if $rowValid -}}
    <tr>
        {{- if eq $lineNo 0 }}<td class="rotright brtb" rowspan="{{$rowCount}}"><strong>Destination</strong></td>{{end -}}
        <td class="brtb"><strong>{{$dest}}</strong></td>
        {{- range $src := $.Params.code_axis -}}
        {{- $opcode := "" -}}
        {{- range $op := $.Params.codes -}}
        {{- $opc := printf "%s %s, %s" $opprefix $dest $src -}}
        {{- if eq $opc $op.op}}{{$opcode = $op}}{{end -}}
        {{- end -}}
        {{- $col := "" -}}
        {{- if ne $opcode "" -}}
            {{- if isset $opcode "colour" }}{{$col = $opcode.colour}}{{end -}}
        {{- end -}}
        <td class="brb {{$col}}">{{- if ne $opcode "" }}{{$opcode.code}}{{end -}}</td>
        {{- end -}}
    </tr>
    {{- end -}}
    {{- end -}}
    </tbody>
</table>
<table class="memoryMap3">
    <caption>Opcode Legend</caption>
    <tbody>
    <tr>
        <td class="green blrtb">Register</td>
        <td class="bnone">&nbsp;</td>
        <td class="yellow blrtb">Memory</td>
        <td class="bnone">&nbsp;</td>
        <td class="blue blrtb">Implicit</td>
        <td class="bnone">&nbsp;</td>
        <td class="orange blrtb">Math</td>
        <td class="bnone">&nbsp;</td>
        <td class="darkblue blrtb">Flow</td>
        <td class="bnone">&nbsp;</td>
        <td class="grey blrtb">Special</td>
        <td class="bnone">&nbsp;</td>
        <td class="unused blrtb">Undefined</td>
    </tr>
    </tbody>
</table>
{{- end -}}
{{- end -}}
{{- end -}}

{{- if isset $.Params "notes" -}}
<div class="printPageBreakAvoid">
    <h3>Notes:</h3>
    <ol>
        {{- range $.Params.notes }}
        <li>{{.}}</li>
        {{end -}}
    </ol>
</div>
{{- end -}}
